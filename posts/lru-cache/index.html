<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.da583fc5e11c557199a9.css">@font-face{font-family:caslon;src:url(https://use.typekit.net/af/3cbd9b/000000000000000000012d68/27/l?fvd=n4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/3cbd9b/000000000000000000012d68/27/d?fvd=n4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/3cbd9b/000000000000000000012d68/27/a?fvd=n4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:normal;font-weight:400}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/200aad/000000000000000000012d67/27/l?fvd=i4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/200aad/000000000000000000012d67/27/d?fvd=i4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/200aad/000000000000000000012d67/27/a?fvd=i4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:italic;font-weight:400}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/ed9e57/000000000000000000012d65/27/l?fvd=n7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/ed9e57/000000000000000000012d65/27/d?fvd=n7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/ed9e57/000000000000000000012d65/27/a?fvd=n7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:normal;font-weight:700}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/d7062a/000000000000000000012d66/27/l?fvd=i7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/d7062a/000000000000000000012d66/27/d?fvd=i7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/d7062a/000000000000000000012d66/27/a?fvd=i7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:italic;font-weight:700}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/68efc1/000000000000000000012d69/27/l?fvd=n6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/68efc1/000000000000000000012d69/27/d?fvd=n6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/68efc1/000000000000000000012d69/27/a?fvd=n6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:normal;font-weight:600}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/8c23a7/000000000000000000012d6a/27/l?fvd=i6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/8c23a7/000000000000000000012d6a/27/d?fvd=i6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/8c23a7/000000000000000000012d6a/27/a?fvd=i6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:italic;font-weight:600}html{font-size:15px}#ribbon{width:100%;height:4px;background-color:#0e638e;position:fixed;top:0;left:0}body{width:87.5%;margin-left:auto;margin-right:auto;padding-left:12.5%;font-family:caslon,Palatino,Palatino Linotype,Palatino LT STD,Book Antiqua,Georgia,serif;background-color:#fcf3d9;color:#000;max-width:1400px;counter-reset:sidenote-counter;text-rendering:optimizeLegibility;-moz-osx-font-smoothing:grayscale;-webkit-font-feature-settings:"kern","onum";font-feature-settings:"kern","onum"}h1,h2,h3,h4,h5{text-transform:uppercase}h1{font-weight:400;font-style:normal;margin-top:4rem;margin-bottom:1.5rem;font-size:1.3rem;line-height:1;border-bottom:1px dotted #000;padding-bottom:.3em;display:inline-block}h1:hover{border-bottom-style:solid}h1>a{color:#000;text-decoration:none}h2{font-style:normal;font-weight:400;margin-top:2.1rem;margin-bottom:1.4rem;font-size:2.5rem;line-height:1;max-width:55%}h3{font-style:normal;margin-top:2rem}h3,h4{font-weight:400;font-size:1.3rem;margin-bottom:1.6rem;line-height:1.6rem;max-width:55%}h4{font-style:italic;margin-top:4rem;border-bottom:1px solid #000}h4:target{padding-top:20px}h5{font-style:italic;font-weight:400;font-size:1rem;margin-top:3rem;margin-bottom:1.6rem;line-height:1.6rem;max-width:55%}hr{display:block;height:1px;border:0;border-top:1px solid #000;margin:1em 0;padding:0;width:55%}p.subtitle{font-style:italic;margin-top:1rem;margin-bottom:1rem;font-size:1.8rem;display:block;line-height:1}.numeral{font-family:sans-serif}.danger{color:red}.divider{text-align:center;font-size:24px;margin-top:40px;margin-bottom:90px}section{padding-top:1rem;padding-bottom:1rem}code{color:#d42a20}div.paragraph,ol,p,ul{font-size:1.4rem;line-height:2rem}ul{list-style-type:". "}div.paragraph,p{margin-top:1.4rem;margin-bottom:1.4rem;padding-right:0;vertical-align:baseline}div.epigraph{margin:5em 0}div.epigraph>blockquote{margin-top:3em;margin-bottom:3em}div.epigraph>blockquote,div.epigraph>blockquote>p{font-style:italic}div.epigraph>blockquote>footer{font-style:normal}div.epigraph>blockquote>footer>cite{font-style:italic}blockquote{font-size:1.4rem}blockquote p{width:55%;margin-right:40px}blockquote footer{width:55%;font-size:1.1rem;text-align:right}section>div.paragraph,section>footer,section>p,section>table{width:55%}section>ol,section>ul{width:50%;-webkit-padding-start:5%}li:not(:first-child){margin-top:.25rem}figure{padding:0;border:0;font-size:100%;font:inherit;max-width:55%;-webkit-margin-start:0;-webkit-margin-end:0;margin:0 0 3em}figcaption,figure{vertical-align:baseline}figcaption{float:right;clear:right;margin-top:0;margin-bottom:0;font-size:1.1rem;line-height:1.6;position:relative;max-width:40%}figure.fullwidth figcaption{margin-right:24%}th{text-align:left}a{color:#000;-webkit-text-decoration-style:dotted;text-decoration-style:dotted}a:hover{-webkit-text-decoration-style:solid;text-decoration-style:solid}img{max-width:100%}.marginnote,.sidenote{float:right;clear:right;margin-right:-60%;width:50%;margin-top:0;margin-bottom:0;position:relative}.marginnote,.marginnote ol,.marginnote ul,.sidenote{font-size:1.1rem;line-height:1.3;vertical-align:baseline}.sidenote{margin-bottom:10px}.sidenote-number{counter-increment:sidenote-counter}.sidenote-number:after,.sidenote:before{font-family:sans-serif;position:relative;vertical-align:baseline}.sidenote-number:after{content:counter(sidenote-counter);font-size:.7rem;padding-right:.2rem;top:-.5rem;left:.1rem}.sidenote-number:last-of-type:after{padding-right:.5rem}.sidenote:before{content:counter(sidenote-counter) " ";font-size:.7rem;top:-.5rem}blockquote .marginnote,blockquote .sidenote{margin-right:-82%;min-width:59%;text-align:left}div.fullwidth,table.fullwidth{width:100%}div.table-wrapper{overflow-x:auto;font-family:Trebuchet MS,Gill Sans,Gill Sans MT,sans-serif}.sans{font-family:Gill Sans,Gill Sans MT,Calibri,sans-serif;letter-spacing:.03em}code{font-family:Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:.85em;line-height:1.42;-webkit-text-size-adjust:100%}.sans>code{font-size:1.2rem}h1>code,h2>code,h3>code{font-size:.8em}.marginnote>code,.sidenote>code,section>pre{font-size:1rem}section>pre{width:55%;border:1px dashed #000;overflow-y:auto}pre.code{font-size:.9rem;width:52.5%;margin-left:2.5%;overflow-x:auto}pre.code.fullwidth{width:90%}.fullwidth{max-width:90%;clear:both}span.newthought{font-variant:small-caps;font-size:1.2em}input.margin-toggle{display:none}label.sidenote-number{display:inline}label.margin-toggle:not(.sidenote-number){display:none}.iframe-wrapper{position:relative;padding-bottom:56.25%;padding-top:25px;height:0}.iframe-wrapper iframe{position:absolute;top:0;left:0;width:100%;height:100%}@media (max-width:760px){body{width:84%;padding-left:8%;padding-right:8%}h1,h2,h3,h4,h5,hr,section>div.paragraph,section>footer,section>p,section>table{width:100%}h1,h2,h3,h4,h5{max-width:100%}section>pre{width:100%}section>ol,section>ul{width:90%}figure{max-width:90%}figcaption,figure.fullwidth figcaption{margin-right:0;max-width:none}blockquote{margin-left:1.5em;margin-right:0}blockquote footer,blockquote p{width:100%}label.margin-toggle:not(.sidenote-number){display:inline}.marginnote,.sidenote{display:none}.margin-toggle:checked+.marginnote,.margin-toggle:checked+.sidenote{display:block;float:left;left:1rem;clear:both;width:95%;margin:1rem 2.5%;vertical-align:baseline;position:relative}label{cursor:pointer}div.table-wrapper,table{width:85%}img{width:100%}}</style><meta name="generator" content="Gatsby 2.13.1"/><link as="script" rel="preload" href="/component---src-templates-mdx-post-js-ff4ff1fe2727a448c301.js"/><link as="script" rel="preload" href="/app-8f23cf1abbd750a1ab02.js"/><link as="script" rel="preload" href="/6-4f0e0d9862cbce5f1548.js"/><link as="script" rel="preload" href="/1-fa9cc3a14d9a3a9ae0e5.js"/><link as="script" rel="preload" href="/styles-8a851a0dd4915f54a3b8.js"/><link as="script" rel="preload" href="/webpack-runtime-d033c6cdf0ed463e3f28.js"/><link as="fetch" rel="preload" href="/page-data/posts/lru-cache/page-data.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div id="ribbon"></div><header><h1><a href="/">Yomguithereal’s shenanigans</a></h1><a href="https://github.com/Yomguithereal" target="_blank" rel="noopener noreferrer" title="github.com/Yomguithereal"><svg width="20" height="20" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg" style="position:relative;top:2px;margin-left:20px"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)" fill="#1B1F23"></path></svg></a><a href="https://twitter.com/Yomguithereal" target="_blank" rel="noopener noreferrer" title="twitter.com/Yomguithereal"><svg viewBox="0 0 300.00006 244.18703" height="20" width="20" style="position:relative;top:2px;margin-left:5px"><g transform="translate(-539.17946,-568.85777)"><path style="fill:black;fill-opacity:1;fill-rule:nonzero;stroke:none" d="m 633.89823,812.04479 c 112.46038,0 173.95627,-93.16765 173.95627,-173.95625 0,-2.64628 -0.0539,-5.28062 -0.1726,-7.90305 11.93799,-8.63016 22.31446,-19.39999 30.49762,-31.65984 -10.95459,4.86937 -22.74358,8.14741 -35.11071,9.62551 12.62341,-7.56929 22.31446,-19.54304 26.88583,-33.81739 -11.81284,7.00307 -24.89517,12.09297 -38.82383,14.84055 -11.15723,-11.88436 -27.04079,-19.31655 -44.62892,-19.31655 -33.76374,0 -61.14426,27.38052 -61.14426,61.13233 0,4.79784 0.5364,9.46458 1.58538,13.94057 -50.81546,-2.55686 -95.87353,-26.88582 -126.02546,-63.87991 -5.25082,9.03545 -8.27852,19.53111 -8.27852,30.73006 0,21.21186 10.79366,39.93837 27.20766,50.89296 -10.03077,-0.30992 -19.45363,-3.06348 -27.69044,-7.64676 -0.009,0.25652 -0.009,0.50661 -0.009,0.78077 0,29.60957 21.07478,54.3319 49.0513,59.93435 -5.13757,1.40062 -10.54335,2.15158 -16.12196,2.15158 -3.93364,0 -7.76596,-0.38716 -11.49099,-1.1026 7.78383,24.2932 30.35457,41.97073 57.11525,42.46543 -20.92578,16.40207 -47.28712,26.17062 -75.93712,26.17062 -4.92898,0 -9.79834,-0.28036 -14.58427,-0.84634 27.05868,17.34379 59.18936,27.46396 93.72193,27.46396"></path></g></svg></a></header><article><section><h2>Implementing an efficient LRU cache for JavaScript</h2><h3>Where we discover how to harness the power of JavaScript&#x27;s typed array to design our very own low-cost pointer system for fixed-capacity data structures</h3><hr/><small><a href="#implementing-doubly-linked-lists-in-javascript">I already know about LRU caches and doubly-linked lists. Bring me to the juicy part dammit!</a></small><p>Let&#x27;s say we need to process a very large, hundreds of gigabytes large, csv file containing urls we will need to fetch. To ensure we are not going to run out of memory while parsing the whole file, we need to read the file line by line:</p><pre><pre class="prism-code language-js" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token plain">csv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">forEachLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">line</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#0e638e">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">line</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div></pre></pre><p>Now let&#x27;s say the person that created this file forgot to deduplicate the urls.<label class="margin-toggle sidenote-number" for="urls-dedup"></label><input type="checkbox" id="urls-dedup" class="margin-toggle"/><span class="sidenote">I am aware that we could easily solve the issue by using <code>sort -u</code> but for the purpose of the demonstration, let&#x27;s imagine this kind of solution does not exist.</span><label class="margin-toggle sidenote-number" for="ural"></label><input type="checkbox" id="ural" class="margin-toggle"/><span class="sidenote">Deduping urls is not as straigthforward as it may seem. Check the <a href="https://github.com/medialab/ural#readme" target="_blank" rel="noopener noreferrer">ural</a> library in python, for instance, for some examples of what can be achieved in this regard.</span>This is an issue because we don&#x27;t want to fetch the same url more than once: grabbing resources from the web is time-consuming &amp; should be done parcimoniously not to overflow the sites you are grabbing those resources from.</p><p>An easy solution could be to remember the url we already fetched by storing them into a map. Our pseudo-code would be changed to the following:</p><pre><pre class="prism-code language-js" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> done </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">csv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">forEachLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">line</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">done</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">has</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">line</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#d42a20">return</span><span class="token plain"> done</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">line</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#0e638e">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">line</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  done</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">line</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div></pre></pre><p>At this point, the astute reader has easily noticed that we just defeated the purpose of reading the csv file line by line since we now need to commit all its urls to memory.</p><p>And herein lies the issue: we need a way not to fetch the same urls too much while also making sure we won&#x27;t run out of memory.</p><p><span class="marginnote"><em>Fun fact</em>: if you work with data coming from the Internet such as lists of crawled urls, you will inevitably stumble upon this kind of power law. It naturally occurs because people link exponentially more to <code>twitter.com</code> than <code>unknownwebsite.fr</code>.</span>Fortunately for us, it seems that only a tiny fraction of the urls contained in our file are repeated very often while the vast majority of others only appears one or two times. We can leverage this fact by designing a policy to throw away urls from our map if we have a good intuition they are unlikely to appear again. Thus, we won&#x27;t allow our map to exceed a predetermined amount of memory.</p><p>As such, one of the most commonly used eviction policy for such cases is called <strong>LRU</strong>, for <strong>L</strong>east <strong>R</strong>ecently <strong>U</strong>sed.</p><h4 id="the-lru-cache">The LRU cache</h4><p>Hence, we understand that a LRU cache is a fixed-capacity map able to bind values to keys with the following twist: if the cache is full but we need to insert a new key-value pair, it will make some place by evicting the least recently used key-value pair.</p><p>To do so, the cache will need to store given pairs in order of their last access. This means that each time someone tries to set a new key, or access a key, we need to modify the underlying list of pairs to ensure the needed order is maintained.</p><p><span class="marginnote"><em>Note</em>: LFU (Least Frequently Used) is a perfectly valid cache eviction policy. It&#x27;s just less widespread. You can read about it <a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least-frequently_used_(LFU)" target="_blank" rel="noopener noreferrer">here</a> and find implementation notes <a href="https://www.geeksforgeeks.org/lfu-least-frequently-used-cache-implementation/" target="_blank" rel="noopener noreferrer">here</a></span>But why is this order relevant? Why not record the number of times each pair is accessed instead and evict the least frequently used item? Here are some reasons why:</p><ul><li>LRU is a actually a good proxy of LFU since the more a pair is accessed, the less chance it has to be evicted.</li><li>You will need to store integers in addition to everything else to keep track of the number of times the pairs were accessed.</li><li>Infering the order of pair access is very straightforward since it can be deduced from the order of operations on the cache.</li><li>With LFU, you will often need to make an arbitrary choice of which pair to evict, for instance if all your pairs have been accessed only once. With LRU, you don&#x27;t have such choice to make: you just evict the least recently used, which cannot be ambiguous.</li><li>LRU is quite straightforward to implement, LFU is not.</li></ul><h4 id="implementing-a-lru-cache">Implementing a LRU cache</h4><p>There are many ways to implement a working LRU cache but I will only focus here on the way you are most likely to encounter in the wild when developing with high-level languages.</p><p>Usually, to implement a proper LRU cache, one will need the two following ingredients:</p><ol><li>A hashmap-like data structure able to retrieve values associated to arbitrary keys - such as strings - efficiently. In JavaScript we can use either the ES6 <code>Map</code> or any plain object <code>{}</code>: remember that our cache is no different from a fixed-capacity key-value store.</li><li>A way to store our pairs in the order of their last access. What&#x27;s more, we will need to be able to travers the list in both normal and reversed order. That&#x27;s why people naturally lean toward a <a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Doubly_linked_list">doubly-linked list</a> to do the job.</li></ol><p>Minimally, your implementation needs to be able to run the two following operations:</p><ul><li><code>#.set</code>: associating a value to the given key, while evicting the least recently used item if the cache is full.</li><li><code>#.get</code>: retrieving the value associated to the given key if this one exists at all in the cache.</li></ul><p>And here is how we could use such a cache:</p><pre><pre class="prism-code language-js" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Let&#x27;s create a cache able to contain 3 items</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> cache </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">LRUCache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Let&#x27;s add items</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&#x27;one&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&#x27;two&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&#x27;three&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Up until now, nothing was evicted from the cache</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&#x27;two&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Oh no! we need to add a new pair</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&#x27;four&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// `1` was evicted because it was the least recently used key</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token keyword nil" style="color:#d42a20">undefined</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// If you get `2`, it won&#x27;t be the LRU anymore</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&#x27;two&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Which means that it&#x27;s `3` that will be evicted now!</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&#x27;five&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token keyword nil" style="color:#d42a20">undefined</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Thus we never store more than 3 pairs</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">size</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div></pre></pre><h4 id="doubly-linked-lists">Doubly-linked lists</h4><div class="paragraph"><span class="marginnote"><em>Question</em>: Why isn&#x27;t a singly-linked list enough in our case? Because we have to efficiently perform the following operations on our list:<ol><li>place an item at the beginning of the list</li><li>move an item from anywhere in the list to its beginning</li><li>remove the last item from the list while keeping a correct pointer to the new last item</li></ol></span>To be able to implement our LRU cache, we will first need to implement a doubly-linked list to make sure we are able to store our items in order of their last access: the least recently used item will be at the end of this list while the most recently used will be at its beginning.</div><p>So how do we represent a doubly-linked list in memory? Usually, we do so by creating a structure containing the following three elements:</p><ol><li>A payload, i.e. the actual list item. It can be anything, really, from an string to an integer etc.</li><li>A pointer towards the previous element in the list.</li><li>A pointer towards the next element in the list.</li></ol><p>Then we also need to store a pointer to both the first &amp; the last element of the list and we are done.</p><p>Schematically, it would look somewhat like this:</p><pre><pre class="prism-code language-c" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token plain">a node</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prev</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">payload</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  payload</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> the stored value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> here</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> it&#x27;s a string</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  prev</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pointer to previous item</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  next</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pointer to next item</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  •</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pointer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  x</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> null pointer</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">a list</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌─────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌────────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘    └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">──────┘</span></div></pre></pre><h4 id="lru-cache-list-operations">LRU Cache list operations</h4><p>As long as the cache is not full, it is quite easy to maintain our list of cached items. We just need to prepend the newly inserted items into the list:</p><pre><pre class="prism-code language-c" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token number" style="color:#0e638e">1.</span><span class="token plain"> an empty cache with capacity </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head x     x tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">2.</span><span class="token plain"> let&#x27;s cache the key </span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌─────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">─────┘</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">3.</span><span class="token plain"> let&#x27;s cache the key </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">notice </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token plain"> comes at the front</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌─────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">─────┘</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">4.</span><span class="token plain"> finally we cache the key </span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌──────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐    ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">               └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">────────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">─────┘</span></div></pre></pre><p>So far so good. Now, to keep our list in LRU order, if anyone accesses an already stored key in the cache we will need to reorder the list by moving said key to the front:</p><pre><pre class="prism-code language-c" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token number" style="color:#0e638e">1.</span><span class="token plain"> the current state of our cache</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌──────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐    ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">               └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">────────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">─────┘</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">2.</span><span class="token plain"> we access the key </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> we first extract it from the list and</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   rewire previous </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> next items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌──────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐    ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">               └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">────────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">─────┘</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  dangling</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">3.</span><span class="token plain"> then we move the node to the front</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌─────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌────────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐    ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘    └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">────────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">─────┘</span></div></pre></pre><p>Note that each time, we need to update the head pointer and that, sometimes, we also need to update the tail pointer.</p><p>Finally, if the cache is already full and we need to insert a yet unknown key, we will need to pop the last item from the list to make place so we can prepend the new one.</p><pre><pre class="prism-code language-c" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token number" style="color:#0e638e">1.</span><span class="token plain"> the current state of our cache</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌─────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌────────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐    ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘    └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">────────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">─────┘</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">2.</span><span class="token plain"> we need to insert the key </span><span class="token string" style="color:#DCA40D">&quot;six&quot;</span><span class="token plain"> but the cache is full</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   we first need to pop </span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> being the LRU item</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌─────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌────────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘    └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">──────┘</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">3.</span><span class="token plain"> then we prepend our new item</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌─────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌────────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;six&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘    └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">──────┘</span></div></pre></pre><p>Here is all you need to know about doubly-linked lists to be able to implement a decent LRU cache.</p><h4 id="implementing-doubly-linked-lists-in-javascript">Implementing doubly-linked lists in JavaScript</h4><p>Now we have a slight issue: the JavaScript language does not have pointers per se. Indeed we can only work by passing references around, represented as object properties.</p><p>This means that, usually, most people will implement linked lists in JavaScript by relying on classes that would look like the following:</p><pre><pre class="prism-code language-js" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// One class for the nodes</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#0e638e">DoublyLinkedListNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">previous</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#d42a20">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#d42a20">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// One class for the list</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#0e638e">DoublyLinkedList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">head</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#d42a20">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">tail</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#d42a20">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Performing operations (should be wrapped in the list&#x27;s method)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">DoublyLinkedList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> node1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">DoublyLinkedList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#DCA40D">&#x27;one&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> node2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">DoublyLinkedList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#DCA40D">&#x27;two&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">head</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">tail</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">node1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">node2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">previous</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span></div></pre></pre><p>While there is nothing wrong with this approach, it still has its drawback that will make any similar-looking implementation quite bad, performance-wise:<label class="margin-toggle sidenote-number" for="linked-list-bad-perf"></label><input type="checkbox" id="linked-list-bad-perf" class="margin-toggle"/><span class="sidenote">This is why you won&#x27;t see many people using linked lists in application JavaScript code.<br/><br/>Only people needing it for very specific use cases where they algorithmically shine will actually use them.<br/><br/>node.js has such an implementation <a href="https://github.com/nodejs/node/blob/master/lib/internal/linkedlist.js" target="_blank" rel="noopener noreferrer">here</a> and you can find it used for timers <a href="https://github.com/nodejs/node/blob/master/lib/internal/timers.js" target="_blank" rel="noopener noreferrer">here</a></span></p><ol><li>Each time you instantiate a node, some superflous memory will be allocated for the object&#x27;s bookkeeping.</li><li>If your list moves fast, i.e. nodes are often added or removed, it will trigger garbage collection, whose behavior is, in JavaScript, beyond your control.</li><li>Engines will try to optimize your objects as low-level structs most of the time, as opposed to a hashmap, but you have no control over it.</li><li>Finally, and this is related to <code>3.</code>, object property access is not the fastest thing in the world.</li></ol><p>But here we can be a little more clever than that. Indeed, there is a characteristic of our linked list that we can leverage to be more performant: its capacity is fixed.</p><p>So, instead of using JavaScript references &amp; properties as pointers, let&#x27;s roll our own pointer system using <a target="_blank" rel="noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">Typed Arrays</a>!</p><h4 id="a-custom-pointer-system">A custom pointer system</h4><p>Typed Arrays are very handy JavaScript objects able to represent fixed-capacity arrays containing a certain amount of typical number types such as <code>int32</code> or <code>float64</code> and so on...</p><p>They are fairly fast and consume very little memory because the stored items are statically typed and therefore induce no bookkeeping overhead.</p><p>Here is how you would use one:</p><pre><pre class="prism-code language-js" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Let&#x27;s create a typed array containing 256 unsigned 16 bits integers</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> array </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">Uint16Array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Every item is initially set to 0.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// You can read/set items the same way you would with a vanilla Array</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#0e638e">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">34</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#0e638e">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">34</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// But here&#x27;s the catch: you cannot push new items</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#0e638e">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">45</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">throw</span><span class="token plain"> </span><span class="token template-string string" style="color:#DCA40D">`TypeError: array.push is not a function`</span><span class="token plain"></span></div></pre></pre><p><span class="marginnote">What&#x27;s more, instantiating a typed array in JavaScript is not so far, conceptually, from calling a <code>malloc</code> in C. Or, at least, you can somewhat use them to perform the same kind of tasks in both languages.</span>Since we can now use those very performant arrays, why shouldn&#x27;t we use them to implement our own pointer system? After all, pointers are nothing more than addresses mapping a chunk of memory.</p><p>Then let&#x27;s use a typed array as our chunk of memory and let&#x27;s use indices into it as our addresses! The only tricky part is to correctly choose the integer type, relative to our capacity, to avoid overflows.<label class="margin-toggle sidenote-number" for="get-pointer-array"></label><input type="checkbox" id="get-pointer-array" class="margin-toggle"/><span class="sidenote">If you are ever unsure how to develop this, check this function right <a href="https://github.com/Yomguithereal/mnemonist/blob/7ea90e6fec46b4c2283ae88f173bfb19ead68734/utils/typed-arrays.js#L8-L54" target="_blank" rel="noopener noreferrer">here</a></span></p><p>So, in order to implement a fixed-capacity doubly-linked list in JavaScript to serve our LRU cache structure, we&#x27;ll need the following typed arrays:</p><ol><li>A vanilla array to store our list&#x27;s payloads, i.e. key-value pairs. Or two typed or vanilla arrays to store keys &amp; values separately and depending on their respective types. For instance, if we have the guarantee our value cannot be anything else than 32 bits integers, we can again leverage typed arrays for that.</li><li>A typed array storing a bunch of indices representing our next pointers.</li><li>Another one to store the indices representing our previous pointers.</li></ol><div class="paragraph"><span class="marginnote">Oftentimes, when using the <em>typed array storing pointers</em> trick is a bit tedious to code when you need to ensure the <code>0</code> index represents a null value or pointer.<br/><br/>Two somewhat crafty ways to circumvent this issue:<ol><li>You can offset your values array by keeping the first item empty so that the <code>0</code> index does not risk storing anything important.</li><li>You can offset your indices by one but this often requires to perform some light arithmetic on the indices which make the code quite unpalatable and complicated to understand.</li></ol>Note that people also use the trick of using signed typed arrays rather than unsigned ones (indices cannot be negative numbers, obviously) to add one level of indirection: a pointer can signify one thing or the other based on the sign of the index.<br/><br/>You can use this trick, for instance, to flag nodes in a <a href="https://en.wikipedia.org/wiki/Trie" target="_blank" rel="noopener noreferrer">Trie</a> as leaves, by using negative indices, to save up some memory.</span>Our code would subsequently look something like this:</div><pre><pre class="prism-code language-js" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#d42a20">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#0e638e">FixedCapacityDoublyLinkedList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">capacity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">keys</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">Array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">capacity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">values</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">Uint8Array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">capacity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">Uint8Array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">capacity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">previous</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">Uint8Array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">capacity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">head</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#d42a20">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">tail</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// And if we recall this example from before:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">DoublyLinkedList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> node1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">DoublyLinkedList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#DCA40D">&#x27;one&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> node2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">DoublyLinkedList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#DCA40D">&#x27;two&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">head</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">tail</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">node1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">node2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">previous</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// This now would look more like this:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#d42a20">const</span><span class="token plain"> list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#d42a20">new</span><span class="token plain"> </span><span class="token class-name">FixedCapacityDoublyLinkedList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// First node</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">keys</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&#x27;one&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">values</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Second node</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">keys</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&#x27;two&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">values</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Wiring &amp; pointer mangling</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">next</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">previous</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">head</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">tail</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div></pre></pre><p>Now, instead of setting node instances properties, we lookup &amp; set indices in typed arrays.</p><p>Schematically, again, here is what we are doing:</p><pre><pre class="prism-code language-c" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token plain">To represent the following list</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">       ┌──────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐    ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐   ┌───────</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">┐</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head • </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">•</span><span class="token operator" style="color:#393A34">|</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> • tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">               └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">────────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">───────┘   └</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">─────┘</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">We will store the following indices </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> arrays</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  tail     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  capacity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  size     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  index       </span><span class="token number" style="color:#0e638e">0</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">1</span><span class="token plain">       </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  prev   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  next   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">x </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">null pointer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> should be </span><span class="token number" style="color:#0e638e">0</span><span class="token plain"> here</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> it&#x27;s easier</span></div><div class="token-line" style="color:#393A34"><span class="token plain">to reason about likewise</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> so you are not hampered</span></div><div class="token-line" style="color:#393A34"><span class="token plain">by squishy implementation details</span></div></pre></pre><p>So, if we “rerun” our <a href="#lru-cache-related-doubly-linked-lists-operations">previous examples</a> about list operations needed by our LRU cache using our new scheme:</p><pre><pre class="prism-code language-c" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token number" style="color:#0e638e">1.</span><span class="token plain"> We start with an empty list</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  tail     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  capacity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  size     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  index       </span><span class="token number" style="color:#0e638e">0</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">1</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  prev   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  next   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">2.</span><span class="token plain"> We insert </span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  tail     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  capacity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  size     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  index       </span><span class="token number" style="color:#0e638e">0</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">1</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  prev   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  next   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">3.</span><span class="token plain"> We insert </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  tail     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  capacity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  size     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  index       </span><span class="token number" style="color:#0e638e">0</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">1</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  prev   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  next   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">4.</span><span class="token plain"> We insert </span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  tail     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  capacity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  size     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  index       </span><span class="token number" style="color:#0e638e">0</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">1</span><span class="token plain">       </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  prev   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  next   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">5.</span><span class="token plain"> We access </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token plain"> and bring it the the front of the list</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  tail     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  capacity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  size     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  index       </span><span class="token number" style="color:#0e638e">0</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">1</span><span class="token plain">       </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  prev   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    </span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  next   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#0e638e">6.</span><span class="token plain"> Finally we insert </span><span class="token string" style="color:#DCA40D">&quot;six&quot;</span><span class="token plain"> and evict </span><span class="token string" style="color:#DCA40D">&quot;one&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  head     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  tail     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  capacity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  size     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  index       </span><span class="token number" style="color:#0e638e">0</span><span class="token plain">      </span><span class="token number" style="color:#0e638e">1</span><span class="token plain">       </span><span class="token number" style="color:#0e638e">2</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#DCA40D">&quot;six&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&quot;two&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#DCA40D">&quot;three&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  prev   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  next   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">    x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token number" style="color:#0e638e">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div></pre></pre><p>It looks boring, no?</p><p>Well it&#x27;s actually a good thing. Because it means that we don&#x27;t move things around too much. We don&#x27;t create things, we just read &amp; write array indices.</p><p>So why is this faster than the traditional implementation with object properties we saw earlier?</p><ol><li>We only allocate memory once. We never instantiate new objects. We never need to garbage collect old ones.<label class="margin-toggle sidenote-number" for="pool"></label><input type="checkbox" id="pool" class="margin-toggle"/><span class="sidenote">Yes you can temper memory allocation and garbage collection by using object pools. But if you can rely on typed arrays instead you&#x27;ll find that it&#x27;s faster and consumes less memory.</span>And memory predictability is a desirable thing to have in a LRU cache implementation. The only memory hiccups in our implementation will be the result of setting keys in our map or object up to capacity then evicting keys later on.</li><li>Array indices lookups/writes are really fast because the allocated memory is mostly contiguous, even more with typed arrays. You never need to jump very far to find what you need and cache optimizations can more easily leverage their magic.</li><li>It leaves nothing to interpretation so that the engine does not have to be clever about anything and will be able to automatically take the fast paths relying on very low-level optimizations.</li></ol><h4 id="but-is-it-really-worth-the-hassle">But is it really worth the hassle?</h4><p>To make sure of this, I obviously had to implement such a custom pointer system and benchmark it.</p><p>You can therefore find a typed array-based implementation of a LRU cache in the <a target="_blank" rel="noopener noreferrer" href="https://github.com/Yomguithereal/mnemonist">mnemonist</a> library. You will find one implementation relying on a JavaScript object: the <a target="_blank" rel="noopener noreferrer" href="https://yomguithereal.github.io/mnemonist/lru-cache"><code>LRUCache</code></a>, and another one relying on an ES6 <code>Map</code>: the <a target="_blank" rel="noopener noreferrer" href="https://yomguithereal.github.io/mnemonist/lru-map"><code>LRUMap</code></a>.</p><p>Then there is this public benchmark on the <a target="_blank" rel="noopener noreferrer" href="https://github.com/dominictarr/bench-lru">dominictarr/bench-lru</a> repository.</p><p>And here are some of the latest results:<label class="margin-toggle sidenote-number" for="bench"></label><input type="checkbox" id="bench" class="margin-toggle"/><span class="sidenote">Note that I hid results from the <a href="https://npmjs.com/package/hashlru" target="_blank" rel="noopener noreferrer">hashlru</a> and <a href="https://npmjs.com/package/quick-lru" target="_blank" rel="noopener noreferrer">quick-lru</a> because they are not traditional LRU caches and consume twice the required memory.<br/><br/>They still have, mostly the first one, good write performance but somewhat less good read performance.</span></p><table><thead><tr><th>library</th><th>set</th><th>get1</th><th>update</th><th>get2</th><th>evict</th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener noreferrer" href="https://www.npmjs.com/package/mnemonist">mnemonist-object</a></td><td>15314</td><td>69444</td><td>35026</td><td>68966</td><td>7949</td></tr><tr><td><a target="_blank" rel="noopener noreferrer" href="https://npmjs.com/package/tiny-lru">tiny-lru</a></td><td>6530</td><td>46296</td><td>37244</td><td>42017</td><td>5961</td></tr><tr><td><a target="_blank" rel="noopener noreferrer" href="https://npmjs.com/package/lru-fast">lru-fast</a></td><td>5979</td><td>36832</td><td>32626</td><td>40900</td><td>5929</td></tr><tr><td><a target="_blank" rel="noopener noreferrer" href="https://www.npmjs.com/package/mnemonist">mnemonist-map</a></td><td>6272</td><td>15785</td><td>10923</td><td>16077</td><td>3738</td></tr><tr><td><a target="_blank" rel="noopener noreferrer" href="https://www.npmjs.com/package/lru">lru</a></td><td>3927</td><td>5454</td><td>5001</td><td>5366</td><td>2827</td></tr><tr><td><a target="_blank" rel="noopener noreferrer" href="https://npmjs.com/package/simple-lru-cache">simple-lru-cache</a></td><td>3393</td><td>3855</td><td>3701</td><td>3899</td><td>2496</td></tr><tr><td><a target="_blank" rel="noopener noreferrer" href="https://npmjs.com/package/hyperlru-object">hyperlru-object</a></td><td>3515</td><td>3953</td><td>4044</td><td>4102</td><td>2495</td></tr><tr><td><a target="_blank" rel="noopener noreferrer" href="https://www.npmjs.com/package/js-lru">js-lru</a></td><td>3813</td><td>10010</td><td>9246</td><td>10309</td><td>1843</td></tr></tbody></table><p>mnemonist&#x27;s custom pointer system fares quite well.</p><p>What&#x27;s more, you&#x27;ll see by reading its <a target="_blank" rel="noopener noreferrer" href="https://github.com/Yomguithereal/mnemonist/blob/master/lru-cache.js">source code</a> that it&#x27;s not too horrible to read and remains quite simple.</p><h4 id="parting-words">Parting words</h4><p>Now you know how to use JavaScript typed arrays to create your own pointer system. This trick is not limited to fixed-capacity linked lists and can be used for a variety or other data structure implementation problems.<label class="margin-toggle sidenote-number" for="trees"></label><input type="checkbox" id="trees" class="margin-toggle"/><span class="sidenote">A lot of tree-like data structures may also beneficiate from this trick, for instance.</span></p><p>But as per usual, and this advice stands for most high-level languages<label class="margin-toggle sidenote-number" for="python"></label><input type="checkbox" id="python" class="margin-toggle"/><span class="sidenote">The <em>typed array storing pointers</em> trick is far from suited to every high-level language. In python, for instance, if you try to replicate this trick using <code>bytearray</code> or <code>np.array</code> you will actually get abysmal performances.</span>, optimizing JavaScript is the same as squinting really hard and pretending the language:</p><ol><li>has static typing</li><li>is low-level</li></ol><p>Basically, the less choices the engine has to make, the easier it will be for it to optimize your code.</p><p>Of course this is not advisable for application code and this level of optimization should only be a goal if you try to optimize critical things such as, off the top of my head, a LRU cache.<label class="margin-toggle sidenote-number" for="memoize"></label><input type="checkbox" id="memoize" class="margin-toggle"/><span class="sidenote">LRU cache are very important to many implementations of memoization, for instance.<br/><br/>Web servers and clients alike also massively rely on those kinds of caches.</span></p><p>And finally, please don&#x27;t take my words or advices too seriously. It is notoriously tricky to optimize interpreted languages and JavaScript is even worse because you have to consider JIT compilation and several engines such as Gecko or V8.</p><p>So, pretty please, do benchmark your code because your mileage may vary.</p><p align="center"><br/>Have a good day!</p><p class="divider">⁂</p><h4 id="miscellany">Miscellany</h4><h5>About evictions &amp; splay trees</h5><p>The single thing hampering every JavaScript implementation of a LRU cache is actually evictions. Getting rid of keys from either an object (using the <code>delete</code> keyword) or a map (using the <code>#.delete</code> method) is very costly.<label class="margin-toggle sidenote-number" for="hashlru"></label><input type="checkbox" id="hashlru" class="margin-toggle"/><span class="sidenote">Once again the <a href="https://npmjs.com/package/hashlru" target="_blank" rel="noopener noreferrer">hashlru</a> and <a href="https://npmjs.com/package/quick-lru" target="_blank" rel="noopener noreferrer">quick-lru</a> libraries formulate an original solution to this issue and I warmly encourage you to check them.</span></p><p>There seems to be no way around it because it is quite impossible (yet?) to beat the engines native hashmaps&#x27; performance from within interpreted JavaScript code.<label class="margin-toggle sidenote-number" for="hashmaps"></label><input type="checkbox" id="hashmaps" class="margin-toggle"/><span class="sidenote">The contrary would be very counterintuitive since there is no way to run hash algorithms as fast the engine is able to do natively.<br/><br/>I also attempted other tree-based key-value associative data structures like <a href="https://cr.yp.to/critbit.html" target="_blank" rel="noopener noreferrer">CritBit trees</a> but must report that it&#x27;s not possible to beat a JavaScript object or map thusly.<br/><br/>You can still implement those trees so that they can be from 2 to 5 times less performant only than native objects for certain use case, all while maintaining lexicographical orde. Which is not too shabby. I guess?<br/><br/>Feel free to check the undocumented code <a href="https://github.com/Yomguithereal/mnemonist/blob/master/critbit-tree-map.js" target="_blank" rel="noopener noreferrer">here</a>.</span></p><p>This means that you can&#x27;t roll your own map in JavaScript, a fixed-capacity one with inexpensive deletion for instance, and hope to beat what&#x27;s already provided to you with the native object.</p><p>One interesting solution that would be nice to test is using <a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Splay_tree">splay trees</a>.</p><p>Those trees, being a binary search tree variant, support rather efficient associative key-value operations while being very suited to LRU caches since they already work by “splaying” very frequently accessed key to the top of their hierarchy.</p><h5>What about asm.js &amp; webassembly?</h5><p>Wouldn&#x27;t it be faster to implement a LRU cache using shiny new things such a <code>asm.js</code> or <code>webassembly</code> rather than trying to shoehorn low-level concepts into JavaScript high-level code?</p><p>Well yes. But here is the trick: if you ever need to use this implementation from the JavaScript side, then you are out of luck because it will be slow as hell. Just because communication between the JavaScript side and the, say, webassembly side will slow you down, just a little, but enough to make such an implementation moot.<label class="margin-toggle sidenote-number" for="wasm-communication"></label><input type="checkbox" id="wasm-communication" class="margin-toggle"/><span class="sidenote">Communication between wasm and JS has been wildly improving. Check this very good <a href="https://hacks.mozilla.org/2018/10/calls-between-javascript-and-webassembly-are-finally-fast-%F0%9F%8E%89/" target="_blank" rel="noopener noreferrer">blog post</a> on the matter, for instance.<br/><br/>But it&#x27;s still not enough to justify having hot data structure methods run on the wasm side while being called from the JS side, unfortunately.</span></p><p>However, if you can afford to stay in the webassembly side, because you compile rust to webassembly for instance, then it&#x27;s a tremendous idea to also implement your LRU cache there. You will definitely get better results.</p><h5>Saving one pointer array</h5><p>There is a known trick with LRU cache that enables you to save up one pointer level. It does not mean that you don&#x27;t need a doubly-linked list anymore to be efficient but just that the hashmap/dictionary structure you are using can store pointers to the previous key-value pair rather than the related one to save up memory.</p><p>I won&#x27;t explain this here but you can head to this <a target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/questions/49621983/lru-cache-with-a-singly-linked-list">stackoverflow thread</a> if you want to get the gist of it.</p><p>Just note that it&#x27;s usually not a good idea if you want to be remain performant (computation-wise, not memory-wise, obviously) because it will incur more hashmap lookups, and those are quite costly.</p><h5>About arbitrary evictions</h5><p>Note that the LRU cache implementation proposed here will have a hard time handling arbitrary evictions, i.e. letting the user delete keys.</p><p>Why? Because here, since we only need to swap key-value pairs when inserting a new key that will evict the LRU one, we don&#x27;t need to have a way to find “available” slots in our memory. Those slots, if one can delete keys at will, would then have random places in the typed array and we would need a way to find them back to “reallocate” them.</p><p>This could be done by using an additional array serving as a free pointer stack, but this has obviously a memory and performance cost.</p><h5>A fully dynamic custom pointer system</h5><p>Here I mostly spoke of typed array to implement fixed-capacity pointer systems. But if you are a little bit more ambitious you can very well imagine designing a dynamic-capacity pointer system.</p><p>To do so, you can use dynamic typed arrays like mnemonist&#x27;s <a target="_blank" rel="noopener noreferrer" href="https://yomguithereal.github.io/mnemonist/vector.html">Vector</a>. They can actually be more efficient than vanilla JavaScript arrays when handling numbers and will let you implement what you need.</p><p>I am unsure whether having a custom dynamic pointer system would yield any performance improvement when implementing some other data structure however.</p><h4 id="links">Links</h4><ul><li>You might find the <a target="_blank" rel="noopener noreferrer" href="https://yomguithereal.github.io/mnemonist/">mnemonist</a> library useful. It contains a lot of efficient and cohesive data structure implementations for JavaScript.</li><li>I did a <a target="_blank" rel="noopener noreferrer" href="https://fosdem.org/2019/schedule/event/data_structures_javascript/">talk</a> about implementing data structures in JavaScript at FOSDEM in 2019.</li></ul></section></article></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/lru-cache";window.webpackCompilationHash="dd1129d6be6e17e3e046";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8f23cf1abbd750a1ab02.js"],"component---src-templates-mdx-post-js":["/component---src-templates-mdx-post-js-ff4ff1fe2727a448c301.js"],"component---src-pages-index-js":["/component---src-pages-index-js-e798913424a60e98cee0.js"]};/*]]>*/</script><script src="/webpack-runtime-d033c6cdf0ed463e3f28.js" async=""></script><script src="/styles-8a851a0dd4915f54a3b8.js" async=""></script><script src="/1-fa9cc3a14d9a3a9ae0e5.js" async=""></script><script src="/6-4f0e0d9862cbce5f1548.js" async=""></script><script src="/app-8f23cf1abbd750a1ab02.js" async=""></script><script src="/component---src-templates-mdx-post-js-ff4ff1fe2727a448c301.js" async=""></script></body></html>