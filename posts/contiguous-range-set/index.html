<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.278727ccf9d53df65574.css">@font-face{font-family:caslon;src:url(https://use.typekit.net/af/3cbd9b/000000000000000000012d68/27/l?fvd=n4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/3cbd9b/000000000000000000012d68/27/d?fvd=n4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/3cbd9b/000000000000000000012d68/27/a?fvd=n4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:normal;font-weight:400}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/200aad/000000000000000000012d67/27/l?fvd=i4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/200aad/000000000000000000012d67/27/d?fvd=i4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/200aad/000000000000000000012d67/27/a?fvd=i4&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:italic;font-weight:400}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/ed9e57/000000000000000000012d65/27/l?fvd=n7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/ed9e57/000000000000000000012d65/27/d?fvd=n7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/ed9e57/000000000000000000012d65/27/a?fvd=n7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:normal;font-weight:700}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/d7062a/000000000000000000012d66/27/l?fvd=i7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/d7062a/000000000000000000012d66/27/d?fvd=i7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/d7062a/000000000000000000012d66/27/a?fvd=i7&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:italic;font-weight:700}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/68efc1/000000000000000000012d69/27/l?fvd=n6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/68efc1/000000000000000000012d69/27/d?fvd=n6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/68efc1/000000000000000000012d69/27/a?fvd=n6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:normal;font-weight:600}@font-face{font-family:caslon;src:url(https://use.typekit.net/af/8c23a7/000000000000000000012d6a/27/l?fvd=i6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff2"),url(https://use.typekit.net/af/8c23a7/000000000000000000012d6a/27/d?fvd=i6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("woff"),url(https://use.typekit.net/af/8c23a7/000000000000000000012d6a/27/a?fvd=i6&primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&v=3) format("opentype");font-style:italic;font-weight:600}html{font-size:15px}#ribbon{width:100%;height:4px;background-color:#0e638e;position:fixed;top:0;left:0}body{width:87.5%;margin-left:auto;margin-right:auto;padding-left:12.5%;font-family:caslon,Palatino,Palatino Linotype,Palatino LT STD,Book Antiqua,Georgia,serif;background-color:#fcf3d9;color:#000;max-width:1400px;counter-reset:sidenote-counter;text-rendering:optimizeLegibility;-moz-osx-font-smoothing:grayscale;font-feature-settings:"kern","onum"}h1,h2,h3,h4,h5{text-transform:uppercase}h1{font-weight:400;font-style:normal;margin-top:4rem;margin-bottom:1.5rem;font-size:1.3rem;line-height:1;border-bottom:1px dotted #000;padding-bottom:.3em;display:inline-block}h1.main-title:hover{border-bottom-style:solid}h1>a{color:#000;text-decoration:none}h2{font-style:normal;font-weight:400;margin-top:2.1rem;margin-bottom:1.4rem;font-size:2.5rem;line-height:1;max-width:55%}h3{font-style:normal;margin-top:2rem}h3,h4{font-weight:400;font-size:1.3rem;margin-bottom:1.6rem;line-height:1.6rem;max-width:55%}h4{font-style:italic;margin-top:4rem;border-bottom:1px solid #000}h4:target,h5:target{padding-top:20px}h5{font-style:italic;font-weight:400;font-size:1rem;margin-top:3rem;margin-bottom:1.6rem;line-height:1.6rem;max-width:55%}hr{display:block;height:1px;border:0;border-top:1px solid #000;margin:1em 0;padding:0;width:55%}p.subtitle{font-style:italic;margin-top:1rem;margin-bottom:1rem;font-size:1.8rem;display:block;line-height:1}.numeral{font-family:sans-serif}.danger{color:red}.divider{text-align:center;font-size:24px;margin-top:40px;margin-bottom:90px}section{padding-top:1rem;padding-bottom:1rem}code{color:#d42a20}div.paragraph,ol,p,ul{font-size:1.4rem;line-height:2rem}ul{list-style-type:". "}div.paragraph,p{margin-top:1.4rem;margin-bottom:1.4rem;padding-right:0;vertical-align:baseline}div.epigraph{margin:5em 0}div.epigraph>blockquote{margin-top:3em;margin-bottom:3em}div.epigraph>blockquote,div.epigraph>blockquote>p{font-style:italic}div.epigraph>blockquote>footer{font-style:normal}div.epigraph>blockquote>footer>cite{font-style:italic}blockquote{font-size:1.4rem}blockquote p{width:55%;margin-right:40px}blockquote footer{width:55%;font-size:1.1rem;text-align:right}section>div.paragraph,section>footer,section>p,section>table{width:55%}section>ol,section>ul{width:50%;-webkit-padding-start:5%}li:not(:first-child){margin-top:.25rem}figure{padding:0;border:0;font-size:100%;font:inherit;max-width:55%;-webkit-margin-start:0;-webkit-margin-end:0;margin:0 0 3em}figcaption,figure{vertical-align:baseline}figcaption{float:right;clear:right;margin-top:0;margin-bottom:0;font-size:1.1rem;line-height:1.6;position:relative;max-width:40%}figure.fullwidth figcaption{margin-right:24%}a{color:#000}section a{background-image:-webkit-gradient(linear,left top,right top,color-stop(50%,#000),color-stop(50%,transparent));background-image:linear-gradient(90deg,#000 50%,transparent 0);background-size:3px 1px;text-decoration:none}section a,section a:hover{background-position:0 1.1em;background-repeat:repeat-x}section a:hover{-webkit-text-decoration:underline solid;text-decoration:underline solid;background-image:-webkit-gradient(linear,left top,left bottom,to(#000));background-image:linear-gradient(180deg,#000);background-size:1px 1px}img{max-width:100%}.marginnote,.sidenote{float:right;clear:right;margin-right:-60%;width:50%;margin-top:0;margin-bottom:0;position:relative}.marginnote,.marginnote ol,.marginnote ul,.sidenote,.sidenote ol,.sidenote ul{font-size:1.1rem;line-height:1.3;vertical-align:baseline}.sidenote{margin-bottom:10px}.sidenote-number{counter-increment:sidenote-counter}.sidenote-number:after,.sidenote:before{font-family:sans-serif;position:relative;vertical-align:baseline}.sidenote-number:after{content:counter(sidenote-counter);font-size:.7rem;padding-right:.2rem;top:-.5rem;left:.1rem}.sidenote-number:last-of-type:after{padding-right:.5rem}.sidenote:before{content:counter(sidenote-counter) " ";font-size:.7rem;top:-.5rem}blockquote .marginnote,blockquote .sidenote{margin-right:-82%;min-width:59%;text-align:left}div.fullwidth,table.fullwidth{width:100%}div.table-wrapper{overflow-x:auto;font-family:Trebuchet MS,Gill Sans,Gill Sans MT,sans-serif}.sans{font-family:Gill Sans,Gill Sans MT,Calibri,sans-serif;letter-spacing:.03em}code{font-family:Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:.85em;line-height:1.42;-webkit-text-size-adjust:100%}.sans>code{font-size:1.2rem}h1>code,h2>code,h3>code{font-size:.8em}.marginnote>code,.sidenote>code,section>pre{font-size:1rem}section>pre{width:55%;border:1px dashed #000;overflow-y:auto}pre.code{font-size:.9rem;width:52.5%;margin-left:2.5%;overflow-x:auto}pre.code.fullwidth{width:90%}.fullwidth{max-width:90%;clear:both}span.newthought{font-variant:small-caps;font-size:1.2em}input.margin-toggle{display:none}label.sidenote-number{display:inline}label.margin-toggle:not(.sidenote-number){display:none}.iframe-wrapper{position:relative;padding-bottom:56.25%;padding-top:25px;height:0}.iframe-wrapper iframe{position:absolute;top:0;left:0;width:100%;height:100%}br.skipper{display:none}.twitter-logo{position:relative;top:2px;margin-left:5px}.github-logo{position:relative;top:2px;margin-left:20px}.subtoc,.toc{font-size:1.1rem}.subtoc>li,.toc>li{margin-top:0}.subtoc{list-style-type:lower-roman;padding-left:25px;font-size:1rem}@media (max-width:500px){br.skipper{display:block}.github-logo{margin-left:0}}@media (max-width:760px){body{width:84%;padding-left:8%;padding-right:8%}h2,h3,h4,h5,hr,section>div.paragraph,section>footer,section>p,section>table{width:100%}h2,h3,h4,h5{max-width:100%}section>pre{width:100%}section>ol,section>ul{width:90%}figure{max-width:90%}figcaption,figure.fullwidth figcaption{margin-right:0;max-width:none}blockquote{margin-left:1.5em;margin-right:0}blockquote footer,blockquote p{width:100%}label.margin-toggle:not(.sidenote-number){display:inline}.marginnote,.sidenote{display:none}.margin-toggle:checked+.marginnote,.margin-toggle:checked+.sidenote{display:block;float:left;left:1rem;clear:both;width:95%;margin:1rem 2.5%;vertical-align:baseline;position:relative}label{cursor:pointer}div.table-wrapper,table{width:85%}img{width:100%}}</style><meta name="generator" content="Gatsby 2.18.1"/><title data-react-helmet="true">Yomguithereal&#x27;s Shenanigans - Contiguous Range Sets</title><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Contiguous Range Sets"/><meta data-react-helmet="true" name="twitter:description" content="Where we discover how a simple but cunning data structure can help us resuming the collection of a rather large amount of web documents."/><meta data-react-helmet="true" property="og:title" content="Contiguous Range Sets"/><meta data-react-helmet="true" property="og:description" content="Where we discover how a simple but cunning data structure can help us resuming the collection of a rather large amount of web documents."/><meta data-react-helmet="true" name="twitter:creator" content="@Yomguithereal"/><meta data-react-helmet="true" property="og:image" content="https://yomguithereal.github.io/img/avatar.jpg"/><link as="script" rel="preload" href="/webpack-runtime-3529dd02f0496746b91b.js"/><link as="script" rel="preload" href="/app-84b76592fb7181f15aea.js"/><link as="script" rel="preload" href="/styles-898bd2de2c4cb4b67f51.js"/><link as="script" rel="preload" href="/commons-eac6544ff8bb51913fca.js"/><link as="script" rel="preload" href="/component---src-templates-mdx-post-js-e44ad7248481a40675c9.js"/><link as="fetch" rel="preload" href="/page-data/posts/contiguous-range-set/page-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
        var mode = localStorage.getItem('theme-ui-color-mode');
        if (!mode) return
        document.body.classList.add('theme-ui-' + mode);
      } catch (e) {} })();</script><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div id="ribbon"></div><header><h1 class="main-title"><a href="/">Yomguithereal&#x27;s Shenanigans</a></h1><br class="skipper"/><a href="https://github.com/Yomguithereal" target="_blank" rel="noopener noreferrer" title="github.com/Yomguithereal"><svg class="github-logo" width="20" height="20" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)" fill="#1B1F23"></path></svg></a><a href="https://twitter.com/Yomguithereal" target="_blank" rel="noopener noreferrer" title="twitter.com/Yomguithereal"><svg class="twitter-logo" viewBox="0 0 300.00006 244.18703" height="20" width="20"><g transform="translate(-539.17946,-568.85777)"><path style="fill:black;fill-opacity:1;fill-rule:nonzero;stroke:none" d="m 633.89823,812.04479 c 112.46038,0 173.95627,-93.16765 173.95627,-173.95625 0,-2.64628 -0.0539,-5.28062 -0.1726,-7.90305 11.93799,-8.63016 22.31446,-19.39999 30.49762,-31.65984 -10.95459,4.86937 -22.74358,8.14741 -35.11071,9.62551 12.62341,-7.56929 22.31446,-19.54304 26.88583,-33.81739 -11.81284,7.00307 -24.89517,12.09297 -38.82383,14.84055 -11.15723,-11.88436 -27.04079,-19.31655 -44.62892,-19.31655 -33.76374,0 -61.14426,27.38052 -61.14426,61.13233 0,4.79784 0.5364,9.46458 1.58538,13.94057 -50.81546,-2.55686 -95.87353,-26.88582 -126.02546,-63.87991 -5.25082,9.03545 -8.27852,19.53111 -8.27852,30.73006 0,21.21186 10.79366,39.93837 27.20766,50.89296 -10.03077,-0.30992 -19.45363,-3.06348 -27.69044,-7.64676 -0.009,0.25652 -0.009,0.50661 -0.009,0.78077 0,29.60957 21.07478,54.3319 49.0513,59.93435 -5.13757,1.40062 -10.54335,2.15158 -16.12196,2.15158 -3.93364,0 -7.76596,-0.38716 -11.49099,-1.1026 7.78383,24.2932 30.35457,41.97073 57.11525,42.46543 -20.92578,16.40207 -47.28712,26.17062 -75.93712,26.17062 -4.92898,0 -9.79834,-0.28036 -14.58427,-0.84634 27.05868,17.34379 59.18936,27.46396 93.72193,27.46396"></path></g></svg></a></header><article><section><h2>Contiguous Range Sets</h2><h3>Where we discover how a simple but cunning data structure can help us resuming the collection of a rather large amount of web documents.</h3><hr/><p><small><em>Table of Contents</em></small></p><ol class="toc"><li><a href="#risks-of-the-trade">Risks of the trade</a></li><li><a href="#keeping-things-in-order">Keeping things in order</a></li><li><a href="#ordered-output-of-multithreaded-iteration">Ordered output of multithreaded iteration</a></li><li><a href="#a-set-of-already-done-lines">A set of already done lines</a></li><li><a href="#contiguous-range-set">Contiguous range set</a></li><li><a href="#holes">Holes</a></li><li><a href="#almost-ordered-output">Almost ordered output</a></li><li><a href="#concluding-remarks">Concluding remarks</a></li><li><a href="#bonus-keeping-track-of-the-query-sequence">Bonus: keeping track of the query sequence</a></li></ol><hr/><p class="css-0">Picture the scene: using Twitter APIs, we have collected a gazillion of tweets.<label class="margin-toggle sidenote-number" for="gazouilloire"></label><input type="checkbox" id="gazouilloire" class="margin-toggle"/><span class="sidenote">If you ever need to do so, <a href="https://github.com/medialab/gazouilloire" target="_blank" rel="noopener noreferrer">gazouilloire</a> is probably a safe bet as it has been used for several years by Sciences Po&#x27;s <a href="https://medialab.sciencespo.fr/en" target="_blank" rel="noopener noreferrer">m√©dialab</a> for their Twitter data collections.</span>Now our attention focuses on the millions of shared hyperlink we found in those.</p><p class="css-0">What if we could go further than ranking those urls? What if we could extract their raw textual content<label class="margin-toggle sidenote-number" for="dragnet"></label><input type="checkbox" id="dragnet" class="margin-toggle"/><span class="sidenote">Extracting the main content from a web page, i.e. from its HTML representation, is not a trivial task. The <a href="https://github.com/dragnet-org/dragnet" target="_blank" rel="noopener noreferrer">dragnet</a> library, for instance, should get you going.</span>so we can test some of our NLP (<a href="https://en.wikipedia.org/wiki/Natural_language_processing" target="_blank" rel="noopener noreferrer">Natural Language Processing</a>) mojo on it?</p><p class="css-0">But there is a catch! Before being able to do so, we obviously need to fetch those urls. And grabbing millions of urls from the web ought to be slow.</p><p class="css-0">However, it is not entirely hopeless and with some patience, we might rise up to the task.</p><p class="css-0">Of course, the first thing to avoid is to fetch urls one by one, sequentially. Indeed, to dramatically speed up our url collection we can fetch a bunch of them in parallel - granted they are not from the same domain - using multithreaded execution.<label class="margin-toggle sidenote-number" for="gil"></label><input type="checkbox" id="gil" class="margin-toggle"/><span class="sidenote">Even using a language like python and its infamous <a href="https://wiki.python.org/moin/GlobalInterpreterLock" target="_blank" rel="noopener noreferrer">Global Interpreter Lock</a> it is worth a shot because your CPUs are not doing most of the work when fetching resources from the web. That&#x27;s because other servers&#x27; ones are.</span></p><h4 id="risks-of-the-trade">Risks of the trade</h4><p class="css-0">So now we start fetching our urls in parallel, hitting ~100 domains at once for maximum speed. But here the issue: life is harsh and, oftentimes, computer processes may crash for fickle reasons. So what if we started fetching our urls, and halfway through our computer dies?</p><p class="css-0">It would be nice if we could resume the process where we left it. But, being short on resources and wanting to adopt a lo-fi approach our program was not able to use a proper database or queue manager.<label class="margin-toggle sidenote-number" for="queue"></label><input type="checkbox" id="queue" class="margin-toggle"/><span class="sidenote">Of course if you have to scale very high and require top-notch reliance, please rely on a proper database or message queue. <a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>, <a href="https://www.rabbitmq.com/" target="_blank" rel="noopener noreferrer">RabbitMQ</a> or <a href="https://www.postgresql.org/" target="_blank" rel="noopener noreferrer">PostgreSQL</a> naturally come to mind.</span></p><p class="css-0">Thus we only relied on simple CSV files:</p><style data-emotion-css="1uk1gs8">.css-1uk1gs8{margin:0;}</style><ol class="css-1uk1gs8"><li class="css-0">We process urls from an input CSV file line by line to avoid running out of memory (remember we are speaking of gazillions of urls here, it could not fit into memory even if we wanted)</li><li class="css-0">We write a report on another CSV file to keep track of errors and HTTP statuses etc.</li></ol><p class="css-0">We also of course store any retrieved HTML file directly on disk after compressing it to avoid running out of space.</p><p class="css-0">So what solutions can we find to resume our aborted process?</p><h4 id="keeping-things-in-order">Keeping things in order</h4><p class="css-0">An obvious solution could be to output our report in the same order as the input file.</p><p class="css-0">Indeed, if we are working on the following CSV file:</p><table><thead><tr class="css-0"><th align="left">url</th></tr></thead><tbody><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lemonde.fr">https://www.lemonde.fr</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lefigaro.fr">https://www.lefigaro.fr</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.liberation.fr">https://www.liberation.fr</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.echojs.com/">https://www.echojs.com/</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://yomguithereal.github.io/">https://yomguithereal.github.io/</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://github.com/">https://github.com/</a></td></tr><tr class="css-0"><td align="left">...</td></tr></tbody></table><p class="css-0">And if our report currently reads like this:</p><table><thead><tr class="css-0"><th align="left">url</th><th align="left">status</th></tr></thead><tbody><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lemonde.fr">https://www.lemonde.fr</a></td><td align="left"><code>200</code></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lefigaro.fr">https://www.lefigaro.fr</a></td><td align="left"><code>404</code></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.liberation.fr">https://www.liberation.fr</a></td><td align="left"><code>200</code></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.echojs.com/">https://www.echojs.com/</a></td><td align="left"><code>200</code></td></tr></tbody></table><p class="css-0">It is safe to assume we stopped at the fourth url and that we can resume our process starting from the fifth one.</p><p class="css-0">So that&#x27;s it? Problem solved?</p><p class="css-0">Not quite.</p><p class="css-0">Because keeping the output ordered could very well slow us down.</p><h4 id="ordered-output-of-multithreaded-iteration">Ordered output of multithreaded iteration</h4><p class="css-0">Remember that to be fast, we chose to rely on multithreading so that our code is able to hit multiple domains in parallel.</p><p class="css-0">But the fact is our urls will be processed in mostly arbitrary order since we can only fetch a limited number of urls at once and because each url takes a different time to download.</p><p class="css-0">We could still easily re-order the output by using a queue. But remember that all the urls cannot fit into memory at once. This means keeping the output ordered will affect our throughput.</p><p class="css-0">Why? Because some particularly slow urls would now be able to slow down the whole process since we cannot fetch more urls until those slow ones are outputted to the report. Those slow urls are bound to throttle the whole thing.<label class="margin-toggle sidenote-number" for="buffering"></label><input type="checkbox" id="buffering" class="margin-toggle"/><span class="sidenote">It is possible, if you have memory to spare, to keep a buffer of items to be outputted. This can alleviate the issue but cannot fix it altogether since the only way to completely fix it would mean to load everything into memory.</span></p><p class="css-0">But let&#x27;s visualize this so this is clearer.</p><p class="css-0">Here is what the process would look like if we output an ordered report:</p><p class="css-0"><style data-emotion-css="wnzno2">.css-wnzno2{max-width:100%;height:auto;object-fit:cover;}</style><img src="/static/ordered-ad0b3796e8e3f2bbb065f1240790ac3a.gif" alt="ordered process gif" class="css-wnzno2"/></p><p class="css-0">And here is what the process would look like if we don&#x27;t care about the report&#x27;s order:</p><p class="css-0"><style data-emotion-css="wnzno2">.css-wnzno2{max-width:100%;height:auto;object-fit:cover;}</style><img src="/static/unordered-970997d1d537a76394e66bff2b60fe0f.gif" alt="ordered process gif" class="css-wnzno2"/></p><p class="css-0">You should notice that the second process is smoother and faster while the first one hiccups and stalls. And we are only fetching 100 urls here. Imagine how those differences would add up with a million urls.</p><p class="css-0">This means that keeping the report ordered is not a viable solution if we want performance.<label class="margin-toggle sidenote-number" for="lost"></label><input type="checkbox" id="lost" class="margin-toggle"/><span class="sidenote">What&#x27;s more, keeping the report ordered might also mean losing the result of some tasks positioned after some lagging ones but finished before them, in case of a crash.<br/><br/>That&#x27;s because some results will linger in the memory, waiting for the lagging tasks to complete before they can be flushed to the report file.</span></p><p class="css-0">But how can we resume the process if our report is not in the same order as the input?</p><h4 id="a-set-of-already-done-lines">A set of already done lines</h4><p class="css-0">A naive solution would be to start adding a column to our CSV report indicating the index of the line of the input file so we can track lines that were already done.</p><p class="css-0">So a CSV file or urls looking like this:</p><table><thead><tr class="css-0"><th align="left">url</th></tr></thead><tbody><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lemonde.fr">https://www.lemonde.fr</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lefigaro.fr">https://www.lefigaro.fr</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.liberation.fr">https://www.liberation.fr</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.echojs.com/">https://www.echojs.com/</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://yomguithereal.github.io/">https://yomguithereal.github.io/</a></td></tr><tr class="css-0"><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://github.com/">https://github.com/</a></td></tr><tr class="css-0"><td align="left">...</td></tr></tbody></table><p class="css-0">Could yield a report looking like that:</p><table><thead><tr class="css-0"><th align="left">line</th><th align="left">url</th><th align="left">status</th></tr></thead><tbody><tr class="css-0"><td align="left"><code>1</code></td><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lefigaro.fr">https://www.lefigaro.fr</a></td><td align="left"><code>404</code></td></tr><tr class="css-0"><td align="left"><code>0</code></td><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lemonde.fr">https://www.lemonde.fr</a></td><td align="left"><code>200</code></td></tr><tr class="css-0"><td align="left"><code>4</code></td><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://yomguithereal.github.io/">https://yomguithereal.github.io/</a></td><td align="left"><code>200</code></td></tr><tr class="css-0"><td align="left"><code>3</code></td><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.echojs.com/">https://www.echojs.com/</a></td><td align="left"><code>200</code></td></tr></tbody></table><p class="css-0">See how the original lines are outputted in arbitrary order?</p><p class="css-0">We can now read the report file and store the set of lines that were already processed. In our case the set of already done lines would be:</p><pre><pre class="prism-code language-python" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div></pre></pre><p class="css-0">This means that we are now able to skip those lines when reading the input file again.</p><p class="css-0">Unfortunately, this won&#x27;t work in our case either.</p><p class="css-0">Remember that we have an input file that cannot fit into memory. What if the process was aborted not far from the end? Doesn&#x27;t this mean we would need to fit the set of almost every line from our input file into memory?</p><p class="css-0">Yes it does :(</p><h4 id="contiguous-range-set">Contiguous range set</h4><p class="css-0">Enters the <em class="css-0">contiguous range set</em>. A data structure that we will design together to solve the issue at hand.</p><p class="css-0">Our <em class="css-0">contiguous range set</em> will be very similar to the typical <em class="css-0">set</em> in that we need to perform the same kind of operations on it:</p><style data-emotion-css="1uk1gs8">.css-1uk1gs8{margin:0;}</style><ol class="css-1uk1gs8"><li class="css-0">We need to be able to add items to the set</li><li class="css-0">We need to be able to ask whether the set contains a given item</li></ol><p class="css-0">What&#x27;s more, we want those operations to run as fast as possible and we need our custom set to use as little memory as possible.</p><p class="css-0">And, in our case, there are two important facts that we can put to good use:</p><style data-emotion-css="1uk1gs8">.css-1uk1gs8{margin:0;}</style><ol class="css-1uk1gs8"><li class="css-0">The items we want to store are indices of line in a CSV file, i.e. integers ranging from <style data-emotion-css="vgof0f">.css-vgof0f{font-family:"Roboto Mono",Menlo,monospace;}</style><code class="css-vgof0f">0</code> to <code class="css-vgof0f">n</code>.</li><li class="css-0">Our report should be approximately ordered. Indeed, it is very likely that the outputted lines won&#x27;t respect exactly the input order. However it is also very likely that the outputted lines will roughly approximate the input order.</li></ol><p class="css-0">So, given this, could we design a set so that it stores contiguous ranges of indices rather than the indices themselves?</p><h4 id="holes">Holes</h4><p class="css-0">Let&#x27;s picture a report again:</p><table><thead><tr class="css-0"><th align="left">line</th><th align="left">url</th><th align="left">status</th></tr></thead><tbody><tr class="css-0"><td align="left"><code>1</code></td><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lefigaro.fr">https://www.lefigaro.fr</a></td><td align="left"><code>404</code></td></tr><tr class="css-0"><td align="left"><code>0</code></td><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.lemonde.fr">https://www.lemonde.fr</a></td><td align="left"><code>200</code></td></tr><tr class="css-0"><td align="left"><code>4</code></td><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://yomguithereal.github.io/">https://yomguithereal.github.io/</a></td><td align="left"><code>200</code></td></tr><tr class="css-0"><td align="left"><code>3</code></td><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.echojs.com/">https://www.echojs.com/</a></td><td align="left"><code>200</code></td></tr><tr class="css-0"><td align="left"><code>2</code></td><td align="left"><a target="_blank" rel="noopener noreferrer" href="https://www.liberation.fr">https://www.liberation.fr</a></td><td align="left"><code>200</code></td></tr></tbody></table><p class="css-0">Consider that we could represent our set as a list of contiguous ranges of indices contained within it. A range can easily be represented as, for instance, a tuple containing the range&#x27;s start and end index.</p><pre><pre class="prism-code language-python" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># A range containing the indices 1, 2, 3 and 4:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># A range containing only index 3:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div></pre></pre><p class="css-0">Now here is how we would represent our set, as a list of integer ranges (our set is said to store contiguous ranges because we compress any contiguous integers together):</p><pre><pre class="prism-code language-python" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token plain">ranges </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;&gt;&gt; | 1 | https://www.lefigaro.fr          | 404 |</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># We process the first line of our report, ranges becomes:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;&gt;&gt;  | 0 | https://www.lemonde.fr           | 200 |</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># We process the second line</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Notice how we just update the first range</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;&gt;&gt;  | 4 | https://yomguithereal.github.io/ | 200 |</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># We process the third line</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Here we need to add a new range because the new index</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># is not contiguous to any already stored one</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;&gt;&gt;  | 3 | https://www.echojs.com/          | 200 |</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># The fourth...</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &gt;&gt;&gt;  | 2 | https://www.liberation.fr        | 200 |</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># And finally the last one</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Here both ranges, now contiguous, have been merged</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div></pre></pre><p class="css-0">Notice how we keep the list of ranges sorted by start point and how it means that querying the set can be as fast as performing a single <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm" target="_blank" rel="noopener noreferrer">binary search</a>.<label class="margin-toggle sidenote-number" for="binary-search"></label><input type="checkbox" id="binary-search" class="margin-toggle"/><span class="sidenote">If you don&#x27;t remember binary search too well, just remember that it is a convenient way to search for an item in a <strong class="css-0">sorted</strong> list in logarithmic time.</span></p><div class="paragraph css-0">Inserting a new index in this set can also be as fast since we only need to find the insertion point in the list using the same binary search.<label class="margin-toggle sidenote-number" for="list"></label><input type="checkbox" id="list" class="margin-toggle"/><span class="sidenote">Inserting an element in the middle of a list can be costly, even more if you need a list where indexing needs to be done in <code>O(1)</code> so that binary search remains perfomant. But note that:<style data-emotion-css="1uk1gs8">.css-1uk1gs8{margin:0;}</style><ol class="css-1uk1gs8"><li class="css-0">in our case we will see that the size of the list is never very large</li><li class="css-0">it is possible to find hybrid list implementations such as <a href="https://pypi.org/project/blist/" target="_blank" rel="noopener noreferrer">blist</a> in python that made the necessary compromises to make this work</li></ol></span></div><p class="css-0">And here is an interesting thing with this way of representing our set: the maximum number of ranges we need to store in memory for a given sequence of indices cannot exceed the number of holes in said sequence + 1:</p><pre><pre class="prism-code language-python" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token plain">ranges </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># stored sequence of indices: [1], holes: 0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># stored sequence of indices: [0, 1], holes: 0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># stored sequence of indices: [0, 1, _, 4], holes: 1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># stored sequence of indices: [0, 1, _, 3, 4], holes: 1</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># stored sequence of indices: [0, 1, 2, 3, 4], holes: 0</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div></pre></pre><p class="css-0">Therefore, by leveraging binary search, our <em class="css-0">contiguous range set</em> has the following complexities:</p><style data-emotion-css="1uk1gs8">.css-1uk1gs8{margin:0;}</style><ol class="css-1uk1gs8"><li class="css-0">Space complexity of the set is <style data-emotion-css="vgof0f">.css-vgof0f{font-family:"Roboto Mono",Menlo,monospace;}</style><code class="css-vgof0f">O(h)</code>, <code class="css-vgof0f">h</code> being the number of holes in the stored sequence of indices</li><li class="css-0">Time complexity of querying an index in the set is <code class="css-vgof0f">O(log h)</code></li><li class="css-0">Time complexity of inserting an index in the set is <code class="css-vgof0f">O(log h)</code> or <code class="css-vgof0f">O(h)</code> when using a particularly inadequate list implementation</li></ol><p class="css-0">Not bad if you can ensure that <style data-emotion-css="vgof0f">.css-vgof0f{font-family:"Roboto Mono",Menlo,monospace;}</style><code class="css-vgof0f">h</code> remains as little as possible.</p><h4 id="almost-ordered-output">Almost ordered output</h4><p class="css-0">Remember that our report, while being outputted in a different order than the input, still has an order roughly ressembling the input&#x27;s one.</p><p class="css-0">This means that in this precise case, the number of holes in the sequence of integers stored by our set should never be very high.</p><p class="css-0">We will thus be able to fit the set of already processed lines into memory using our cunning representation. No need to fetch urls once more, we can now safely resume our process without running out of memory!</p><h4 id="concluding-remarks">Concluding remarks</h4><p class="css-0">The data structure presented in this article has had many names and variations. I call it <em class="css-0">contiguous range set</em> but others may give it another name.</p><p class="css-0">It is in fact very inspired by <a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Inversion_list">inversion lists</a> that are typically used by regex engines to process character classes such as <style data-emotion-css="vgof0f">.css-vgof0f{font-family:"Roboto Mono",Menlo,monospace;}</style><code class="css-vgof0f">[A-Z0-9]</code> and a lot of Unicode-related routines.</p><p class="css-0">Note also that the concept of the <em class="css-0">contiguous range set</em> can be applied to other use cases dealing with monotonically increasing sequences of numbers that can be contiguous.</p><p class="css-0">Finally, and because this whole blog post was not born out of mere fantasy, know that the solution to our case was found when working on <a target="_blank" rel="noopener noreferrer" href="https://github.com/medialab/minet#readme">minet</a>, a command line tool for <a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Web_mining">webmining</a> written in python, where the <em class="css-0">contiguous range set</em> is used to resume an aborted <style data-emotion-css="vgof0f">.css-vgof0f{font-family:"Roboto Mono",Menlo,monospace;}</style><code class="css-vgof0f">fetch</code> command.</p><p class="css-0">You can even find a very crude python implementation of the <em class="css-0">contiguous range set</em> <a target="_blank" rel="noopener noreferrer" href="https://github.com/medialab/minet/blob/master/minet/contiguous_range_set.py">here</a>.</p><p style="text-align:center" class="css-0"><br/>I wish you a very good day!</p><p class="divider">‚ÅÇ</p><h4 id="bonus-keeping-track-of-the-query-sequence">Bonus: keeping track of the query sequence</h4><p class="css-0">If you want even more performance when testing the existence of indices in the set when reading the input file, you can make the set stateful by recording the last index that was queried.</p><p class="css-0">Indeed, since in this case you have the guarantee that you will read the input line by line in order, you can safely assume that if some index was found in one of the set&#x27;s ranges, you can skip lower ranges altogether and even discard them if you want.</p><p class="css-0">For instance, let&#x27;s say we have the following set:</p><pre><pre class="prism-code language-python" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div></pre></pre><p class="css-0">And you know that the last queried index was <style data-emotion-css="vgof0f">.css-vgof0f{font-family:"Roboto Mono",Menlo,monospace;}</style><code class="css-vgof0f">4</code>.</p><p class="css-0">Then, if now someone asks for index <code>5</code> and you remembered the position of the range where <code>4</code> was found<label class="margin-toggle sidenote-number" for="stateful"></label><input type="checkbox" id="stateful" class="margin-toggle"/><span class="sidenote">Note that if an index is not found in the set you need to remember the range that was just before instead.</span>, then you can skip all lower ranges, effectively treating our set like it was shorter:</p><pre><pre class="prism-code language-python" style="color:#393A34;padding:20px;margin:0px"><div class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#0e638e">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#0e638e">15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div></pre></pre><p class="css-0">If you do so, the time complexity of queries in the set will slowly decrease down to <style data-emotion-css="vgof0f">.css-vgof0f{font-family:"Roboto Mono",Menlo,monospace;}</style><code class="css-vgof0f">O(1)</code> upon reaching the end of the stored ranges.</p></section></article></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/contiguous-range-set";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-84b76592fb7181f15aea.js"],"component---node-modules-gatsby-theme-mdx-deck-src-templates-deck-js":["/component---node-modules-gatsby-theme-mdx-deck-src-templates-deck-js-e32ae25cdc10ddb24aa9.js"],"component---node-modules-gatsby-theme-mdx-deck-src-templates-decks-js":["/component---node-modules-gatsby-theme-mdx-deck-src-templates-decks-js-f09d6d78b39f58a85365.js"],"component---src-templates-mdx-post-js":["/component---src-templates-mdx-post-js-e44ad7248481a40675c9.js"],"component---src-pages-open-source-js":["/component---src-pages-open-source-js-7f41d9aab5513b78473a.js"],"component---src-pages-index-js":["/component---src-pages-index-js-ae87b1e39a3a8df96720.js"]};/*]]>*/</script><script src="/component---src-templates-mdx-post-js-e44ad7248481a40675c9.js" async=""></script><script src="/commons-eac6544ff8bb51913fca.js" async=""></script><script src="/styles-898bd2de2c4cb4b67f51.js" async=""></script><script src="/app-84b76592fb7181f15aea.js" async=""></script><script src="/webpack-runtime-3529dd02f0496746b91b.js" async=""></script></body></html>